define("Purch/Utils/RaasOffer",["Purch/Utils/Templating","URLSearchParams"in window?null:"vendor/url-search-params-polyfill/index"],function(a){"use strict";var b=function(a){this.w=window,this.d=document,this.options=a||{template:'<%= offer.price %> <span class="merchant"> <%= offer.merchant %></span>'},this.gtmDataLayer=this.w.gtmDataLayer||null,void 0===this.options.init&&this.init()};return b.prototype={init:function(a){if(this.w.raasOffers){var b,c=a||this.d;for(var d in this.w.raasOffers)if(this.w.raasOffers.hasOwnProperty(d)&&(b=this.getOffer(d),b.links))for(var e in b.links)if(b.links.hasOwnProperty(e))for(var f=c.querySelectorAll("."+e),g=0,h=f.length;g<h;g++)f[g].className.indexOf(this.getFlag())>-1||(this.setFlag(f[g]),this.updateUrl(f[g],d,b.links[e]))}},getFlag:function(){return this.w.btoa(this.getVisitorId()).replace(/\W/g,"").toLowerCase()},setFlag:function(a){a.className+=" "+this.getFlag()},getOffer:function(a){return this.w.raasOffers&&this.w.raasOffers[a]||{}},addEvents:function(a,b,c,d){var e=this;a.addEventListener("click",function(a){e.click(this,b,c,d)})},getExtra:function(){var a=this.w.Purch&&this.w.Purch.cs_extradata||{};return a.visitor_id=this.getVisitorId(),this.addIfExists("gclid",a),a},getVisitorId:function(){if(this.w.Purch=this.w.Purch||{},this.w.Purch.cs_extradata=this.w.Purch.cs_extradata||{},this.w.Purch.cs_extradata.visitor_id)return this.w.Purch.cs_extradata.visitor_id;if(this.w.Purch.cs_extradata.VISITOR_ID)return this.w.Purch.cs_extradata.VISITOR_ID;var a;return this.w.ga&&(this.w.ga.getAll&&this.w.ga.getAll().length&&this.w.ga.getAll()[0].get&&(a="ga-"+this.w.ga.getAll()[0].get("clientId")),"function"==typeof this.w.ga&&this.w.ga(function(b){b&&b.get&&(a="ga-"+b.get("clientId"))})),a||(this.w.Purch.cs_extradata.visitor_id="visitor-"+(new Date).getTime(),this.w.Purch.cs_extradata.visitor_id)},updateUrl:function(a,b,c){var d=a.getAttribute("href"),e=this.getOffer(b);if(!(d.indexOf("?p=")>=0)&&e.url&&-1!==e.url.indexOf("t.purch.com")){var f=JSON.parse(JSON.stringify(this.getExtra()));f.buttonId=c.buttonId,c.BBC&&(a&&a.getAttribute&&a.getAttribute("data-position")?f.BBC=[c.BBC,a.getAttribute("data-position")].join("_"):f.BBC=c.BBC),f.transactionId=this.getTransactionId(),f.contentID=c.contentID?c.contentID:this.getContentID(),""!==this.getEvergageExperienceIDList()&&(f.evergageExperienceIDList=this.getEvergageExperienceIDList()),f.taasExperimentID=this.getExperimentID(),f.taasExperimentVariant=this.getExperimentVariant(),this.addEvents(a,b,c,f),a.setAttribute("href",e.url+"?p="+this.w.btoa(JSON.stringify(f))),this.trackImpression(a,b,c,f),this.updateTemplate(a,b,c)}},addIfExists:function(a,b){var c=this.getSearchParams().get(a);c&&(b[a]=c)},getSearchParams:function(){return new this.w.URLSearchParams(this.w.top.location.search)},getTransactionId:function(){return Math.floor(1e4*Math.random()).toString()+(new Date).getTime()},getContentID:function(){var a="";return this.w.Purch&&this.w.Purch.Omniture&&this.w.Purch.Omniture.params&&this.w.Purch.Omniture.params.contentID&&(a=this.w.Purch.Omniture.params.contentID),a},getEvergageExperienceIDList:function(){var a=this.w.evergageExperienceIDList?this.w.evergageExperienceIDList:"";return this.w.Purch=this.w.Purch||{},this.w.Purch.evergageExperienceIDList=a,this.w.Purch.evergageExperienceIDList},getExperimentID:function(){var a=this.w.Purch&&this.w.Purch.Omniture&&this.w.Purch.Omniture.params?this.w.Purch.Omniture.params:void 0;if(a&&a.taasExperimentID)return a.taasExperimentID},getExperimentVariant:function(){var a=this.w.Purch&&this.w.Purch.Omniture&&this.w.Purch.Omniture.params?this.w.Purch.Omniture.params:void 0;if(a&&a.taasExperimentVariant)return a.taasExperimentVariant},trackImpression:function(a,b,c,d){if(c&&a&&b&&d){var e=this.getOffer(b);if(e.url_imp){var f=e.url_imp+"?p="+this.w.btoa(JSON.stringify(d)),g=document.createElement("img");g.setAttribute("data-src",f),g.setAttribute("width",1),g.setAttribute("height",1),g.style.width="1px",g.style.height="1px",g.style["min-height"]="1px",g.style["min-width"]="1px",g.style.display="inherit",g.style.visibility="hidden",g.className="lazy",a.parentNode.insertBefore(g,a.nextSibling)}}},updateTemplate:function(b,c,d){if(d&&b&&c){var e=d.templateClass,f=d.template?d.template:this.options.template,g=this.getOffer(c);g.price&&"0"!==g.price&&g.merchant&&e&&-1!==(" "+b.className+" ").indexOf(" "+e+" ")&&(b.innerHTML=a.render(f,{offer:g}))}},click:function(a,b,c,d){var e=this.getOffer(b);c&&c.evars&&(c.evars.transactionID=d.transactionId||this.getTransactionId(),c.evars.eVar43=e.price,c.evars.eVar34=e.merchant,c.evars.productName=c.evars.productName?c.evars.productName:e.product_name,c.evars.contentID=c.evars.contentID?c.evars.contentID:this.getContentID(),c.evars.taasExperimentID=c.evars.taasExperimentID?c.evars.taasExperimentID:this.getExperimentID(),c.evars.taasExperimentVariant=c.evars.taasExperimentVariant?c.evars.taasExperimentVariant:this.getExperimentVariant(),""!==this.getEvergageExperienceIDList()&&(c.evergageExperienceIDList=this.getEvergageExperienceIDList()));var f=JSON.parse(JSON.stringify(c));a&&a.getAttribute&&a.getAttribute("data-position")&&f.BBC&&f.evars&&f.evars.eVar23&&(f.evars.eVar23=[f.BBC,a.getAttribute("data-position")].join("_")),this.gtmDataLayer&&this.gtmDataLayer.push({event:"purch.shopclick","purch.shopclick.datas":{event:f.event,evars:f.evars}})}},b});