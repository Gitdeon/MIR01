define("Purch/Shopping/PriceOffer",["jquery","Purch/Utils/Lazy"],function(a,b){"use strict";var c=function(b){this.options=a.extend({selector:".price-lazy",template:"price",sitecode:"tgus",currency:"$0.00",tradExpectedPrice:"Expected Price",tradOn:"",tradBestPricesTitle:"Best Prices For Tested Products",tradProduct:"Product",tradMerchant:"Merchant",tradPrice:"Price",tradSeeMore:"See More",noImg:"https://img.purch.com/r/60x45/aHR0noImage",multiOffers:!1,init:!0,analyticsTracker:null,shoppingBtnClass:"button-shopping",shoppingBlockClass:"shopping-block",shoppingLinkClass:""},b||{}),this.win=window,this.processed={},!0===this.options.init&&this.initLazy()};return c.prototype={templates:{},initLazy:function(){var c=this;c.setPriceTemplate(),b.initModule({elementsAccessor:c.options.selector+"[data-pid]",processData:a.proxy(c.process,c),onComplete:a.proxy(c.onCompleteLazy,c),callbackType:"fallback",delegateOn:"body",template:a.proxy(c.getTemplate,c)})},onCompleteLazy:function(a){var b=this;"fallback"===a.data("type")&&b.processFallback(a),b.doAnalyticsTracking(a)},setPriceTemplate:function(){var a=this;a.templates.price='<% for(var i = 0; i < results.length; i++){ var result = results[i]; %><% for(var j = 0; i < result.maxOffers; i++) { var offer = result.offers[j]; %><a target="_blank" class="p-button '+a.options.shoppingBtnClass+'" data-href="<%= offer.url %>" title="<%= result.name %>"><%= offer.label %></a><% } %><% } %>',a.templates.link='<% for(var i = 0; i < results.length; i++){ var result = results[i]; %><% for(var j = 0; i < result.maxOffers; i++) { var offer = result.offers[j]; %><a target="_blank" class=" '+a.options.shoppingLinkClass+'" data-href="<%= offer.url %>" title="<%= result.name %>"><%= result.name %></a> <a target="_blank" class=" '+a.options.shoppingLinkClass+'" data-href="<%= offer.url %>" title="<%= result.name %>">(<%= offer.spacelessPrice %> - <span><%= offer.merchant_name %></span>)</a><% } %><% } %>'},getTemplate:function(a){var b=this,c=a&&a.data("tmpl")?a.data("tmpl"):"price";return b.templates[c]},processFallback:function(b){var c=this,d=b.data("fallback");if(d){var e=d.id?d.id:d.guid,f=d.gclid?d.gclid:"",g=d.contentID?d.contentID:"",h=c.makeUrl(d.trackingUrl,d.url,{id:e,xtTemplate:d.shopping_template,xtProduct:d.name,gclid:f,contentID:g},c.getTransactionId());c.updateTemplateUrl(b,h,!0);var i=c.options.analyticsTracker&&c.options.analyticsTracker.Tracking.TRACKING_NS?c.options.analyticsTracker.Tracking.TRACKING_NS:"omniture-tracking",j=c.options.analyticsTracker&&c.options.analyticsTracker.options.trackingClass?c.options.analyticsTracker.options.trackingClass:i,k=j&&b.find("."+j)?b.find("."+j).data(i):null;if(k){var l=a.extend(!0,{},k);l.evars&&l.evars.eVar23&&(l.evars.eVar23=l.evars.eVar23.replace("button","image"));var m=c.getShoppingBlockLink(b);m&&!m.data("review-url")&&(m.data(i,l),m.attr("data-omniture-tracking",JSON.stringify(l)),m.addClass(j))}}},process:function(a,b){var c=this;if(!(a&&a.results&&a.results.length&&a.results[0].offers&&a.results[0].offers.length))return c.processFallback(b),!1;var d=b.data("pid"),e=b.data("fallback"),f=d&&d in c.processed?c.processed[d]:c.processData(a,e);if(f.length){var g;return f[0].offers&&f[0].offers.length&&f[0].offers[0].url&&(g=f[0].offers[0].url),c.updateTemplateUrl(b,g),{results:f}}return c.processFallback(b),!1},getShoppingBlockLink:function(a){var b=this,c=a.closest('*[class^="'+b.options.shoppingBlockClass+'"]');return!!c.length&&c.find("figure > a")},updateTemplateUrl:function(b,c,d){var e=this.getShoppingBlockLink(b),f=b.data("pid");e&&c&&e.attr({href:c,"data-pid":f}),!0===d&&b.find("a").attr({href:c,"data-pid":f}),a(this.win).trigger("scroll")},processData:function(a,b){b=b||{},b.url=this.setSubtagOnUrl(b.url||"");var c=b.id;return this.processed[c]=a.results&&a.results.length?this.makeData(a.results,b):[],this.processed[c]},getLocalizedPrice:function(a,b){var c=a;try{c=this.options.currency.replace(/([0-9]+[.,]+[0-9]+)/g,a),b&&(c=c.replace(/\s/,""))}catch(a){return c}return c},setSubtagOnUrl:function(a){return-1!==a.indexOf("www.amazon.")&&-1===a.indexOf("ascsubtag")&&(a=a+(-1!==a.indexOf("?")?"&":"?")+"ascsubtag=@subtag@"),a},makeData:function(a,b){for(var c=[],d=0;d<a.length;d++){a[d].offers&&a[d].offers.length||(a[d].offers=[],a[d].offers.push(b));var e=this.makeProduct(a[d],b);e&&e.offers&&e.offers.length&&c.push(e)}return c},makeProduct:function(a,b){return a.xtTemplate=b.template||b.shopping_template||"",a.xtProduct=b.name||"",a.image=b.image||a.image||this.options.noImg,a.name=a.xtProduct||b.name||a.name,a.tracking=b.trackingUrl,a.id=a.id||b.id,this.makeOffer(a)},getTransactionId:function(){var a=new Date,b=Math.floor(1e4*Math.random());return a.getTime()+""+b},getOfferLabel:function(a){var b=this,c='<span class="merchant">'+b.options.tradOn+" "+a.merchant_name+"</span>";return a.price?[this.getLocalizedPrice(a.price),'<span class="merchant">'+b.options.tradOn,a.merchant_name+"</span>"].join(" "):c},makeOffer:function(a){a.siteTracker=this.options.sitecode;var b=this.options.multiOffers?a.offers.length:a.offers.length>0?1:a.offers.length;a.maxOffers=b;for(var c=0;c<b;c++){if(!a.offers[c].merchant_name||!a.offers[c].price)return!1;var d=this.getTransactionId(),e=a.offers[c].more?a.offers[c].more:a.offers[c].url;a.offers[c].more=this.makeUrl(a.tracking,e,a,d),a.offers[c].url=this.makeUrl(a.tracking,a.offers[c].url,a,d),a.offers[c].tid=d,a.offers[c].label=this.getOfferLabel(a.offers[c]),a.offers[c].spacelessPrice=a.offers[c]&&a.offers[c].price?this.getLocalizedPrice(a.offers[c].price,!0):""}return a},getDocId:function(){return this.win.Purch&&this.win.Purch.Omniture&&this.win.Purch.Omniture.s&&this.win.Purch.Omniture.s.eVar6?this.win.Purch.Omniture.s.eVar6:""},makeUrl:function(a,b,c,d){if(!b)return null;b=this.setSubtagOnUrl(b);var e=this.options.subtag||"";return e=e.replace(/@tid@/g,encodeURIComponent(d)).replace(/@docId@/g,encodeURIComponent(this.getDocId())).replace(/@pid@/g,encodeURIComponent(c.id)).replace(/@gclid@/g,encodeURIComponent(c.gclid)).replace(/@contentID@/g,encodeURIComponent(c.contentID)).substr(0,99),b=b.replace(/@subtag@/g,e).replace(/%gclid%/g,c.gclid),a?a.replace(/%url%/g,encodeURIComponent(b)).replace(/%template%/g,encodeURIComponent(c.xtTemplate)).replace(/%product%/g,encodeURIComponent(c.xtProduct)).replace(/%xtPage%/g,this.win.xtpage||""):b},doAnalyticsTracking:function(b){var c=this;if(c.options.analyticsTracker&&"function"==typeof c.options.analyticsTracker.setUp){var d=b.data("pid"),e=d&&d in c.processed?c.processed[d]:[];if(e&&e.length){e[0].shoppingTemplate=b.data("shopping-template");var f=b.find("a"),g=this.getShoppingBlockLink(b);if(c.options.analyticsTracker.setUp(f,e[0]),g&&!g.data("review-url")){var h=a.extend(!0,{},e[0]);h.shoppingTemplate&&(h.shoppingTemplate=h.shoppingTemplate.replace("button","image")),c.options.analyticsTracker.setUp(g,h)}}}}},c.initModule=function(a){return new c(a||{})},c});